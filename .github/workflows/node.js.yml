name: Build

on:
  - push

jobs:

  Frontend: 
  name: Frontend
    cache-and-install:
      runs-on: self-hosted
  
      env:
        NEXTAUTH_URL: ${{secrets.NEXTAUTH_URL}}
        GOOGLE_CLIENT_ID: ${{secrets.GOOGLE_CLIENT_ID}}
        GOOGLE_CLIENT_SECRET: ${{secrets.GOOGLE_CLIENT_SECRET}}
        NEXTAUTH_SECRET: ${{secrets.NEXTAUTH_SECRET}}
        NEXT_PUBLIC_BACKEND_URL: ${{secrets.NEXT_PUBLIC_BACKEND_URL}}
        NEXT_PUBLIC_FRONTEND_URL: ${{secrets.NEXT_PUBLIC_FRONTEND_URL}}
        RESEND_API_KEY: ${{secrets.RESEND_API_KEY}}
  
      steps:
        - name: Checkout
          uses: actions/checkout@v3
  
        - name: Install Node.js
          uses: actions/setup-node@v3
          with:
            node-version: 20.11.1
  
        - uses: pnpm/action-setup@v3
          name: Install pnpm
          with:
            version: 8
            run_install: false
  
        - name: Get pnpm store directory
          shell: bash
          run: |
            echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
  
        - uses: actions/cache@v3
          name: Setup pnpm cache
          with:
            path: ${{ env.STORE_PATH }}
            key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
            restore-keys: |
              ${{ runner.os }}-pnpm-store-
  
        - name: Install dependencies
          run: pnpm install
          working-directory: ./client
  
        - name: Build NextJS Application
          run: pnpm build
          working-directory: ./client

    Backend: 
    name: Backend
    cache-and-install:
      runs-on: self-hosted
  
      env:
        DATABASE_URL: ${{secrets.DATABASE_URL}}
        ORIGIN: ${{secrets.ORIGIN}}
        PORT: ${{secrets.PORT}}
        jwtSecretKey: ${{secrets.jwtSecretKey}}
  
      steps:
        - name: Checkout
          uses: actions/checkout@v3
  
        - name: Install Node.js
          uses: actions/setup-node@v3
          with:
            node-version: 20.11.1
  
        - uses: pnpm/action-setup@v3
          name: Install pnpm
          with:
            version: 8
            run_install: false
  
        - name: Get pnpm store directory
          shell: bash
          run: |
            echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
  
        - uses: actions/cache@v3
          name: Setup pnpm cache
          with:
            path: ${{ env.STORE_PATH }}
            key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
            restore-keys: |
              ${{ runner.os }}-pnpm-store-
  
        - name: Install dependencies
          run: pnpm install
          working-directory: ./client
  
        - name: Build NextJS Application
          run: pnpm build
          working-directory: ./client



